# Use your secured Ubuntu 22.04 LTS base image
FROM secured-ubuntu:22.04

# Set environment variables
ENV PATH /usr/local/bin:$PATH
ENV LANG C.UTF-8

# Define Python version and checksum
ENV PYTHON_VERSION=3.12.7
ENV PYTHON_SHA256=24887b92e2afd4a2ac602419ad4b596372f67ac9b077190f459aba390faf5550
ENV GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305

# Install minimal build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget \
        build-essential \
        libssl-dev \
        zlib1g-dev \
        libncursesw6-dev \
        libreadline-dev \
        libffi-dev \
        libbz2-dev \
        liblzma-dev \
        ca-certificates \
        gnupg \
    && rm -rf /var/lib/apt/lists/*

# Download, verify, build, and install Python
RUN set -eux; \
    # Download Python source
    wget -O python.tar.xz "https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tar.xz"; \
    echo "${PYTHON_SHA256} *python.tar.xz" | sha256sum -c -; \
    wget -O python.tar.xz.asc "https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tar.xz.asc"; \
    # Import GPG key and verify signature
    GNUPGHOME="$(mktemp -d)"; export GNUPGHOME; \
    gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys "$GPG_KEY"; \
    gpg --batch --verify python.tar.xz.asc python.tar.xz; \
    gpgconf --kill all; \
    rm -rf "$GNUPGHOME" python.tar.xz.asc; \
    # Extract and build Python
    mkdir -p /usr/src/python && \
    tar -xJf python.tar.xz -C /usr/src/python --strip-components=1 && \
    rm python.tar.xz && \
    cd /usr/src/python && \
    ./configure \
        --enable-optimizations \
        --enable-shared \
        --with-ensurepip=install && \
    make -j"$(nproc)" && \
    make altinstall && \
    # Clean up build dependencies and source
    cd / && \
    rm -rf /usr/src/python && \
    ldconfig && \
    apt-get purge -y --auto-remove wget build-essential && \
    rm -rf /var/lib/apt/lists/*

# Create symlinks for convenience
RUN ln -s /usr/local/bin/python3.12 /usr/local/bin/python3 && \
    ln -s /usr/local/bin/pip3.12 /usr/local/bin/pip3

# Verify Python installation
RUN python3 --version && pip3 --version

# Set the default command to python3
CMD ["python3"]
